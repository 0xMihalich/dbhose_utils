name: Build wheels and create release

on:
  push:
    tags: ["v*"]
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_wheels:
    name: Build wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install cibuildwheel
      run: pip install git+https://github.com/pypa/cibuildwheel.git

    - name: Install ONLY cibuildwheel dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cython setuptools wheel
      shell: bash

    - name: Create setup.py with explicit include_dirs
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup, Extension
        from Cython.Build import cythonize
        import os
        import site
        import subprocess
        import sys

        subprocess.check_call([sys.executable, "-m", "pip", "install", "nativelib"])

        import nativelib
        nativelib_path = os.path.dirname(nativelib.__file__)
        print(f"nativelib path: {nativelib_path}")

        include_dirs = [nativelib_path, '.']

        extensions = [
            Extension(
                "dbhose_utils.common",
                ["src/dbhose_utils/common.pyx"],
                include_dirs=include_dirs,
            )
        ]

        setup(
            ext_modules=cythonize(
                extensions,
                compiler_directives={
                    'language_level': "3",
                }
            ),
        )
        EOF
      shell: bash

    - name: Build wheels
      run: |
        max_retries=3
        for i in $(seq 1 $max_retries); do
          echo "Attempt $i of $max_retries"
          if python -m cibuildwheel --output-dir wheel_prebuild; then
            echo "Build successful on attempt $i"
            break
          else
            echo "Build failed on attempt $i"
            if [ $i -eq $max_retries ]; then
              echo "All attempts failed"
              exit 1
            fi
            echo "Retrying in 10 seconds..."
            sleep 10
          fi
        done
      shell: bash
      env:
        CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-*"
        CIBW_ARCHS_MACOS: "universal2"
        MACOSX_DEPLOYMENT_TARGET: "10.14"
        CIBW_ENVIRONMENT: "PYTHONPATH=$PYTHONPATH:$(python -c 'import site; print(\":\".join(site.getsitepackages()))')"
        CIBW_BEFORE_ALL: "pip install cython setuptools wheel -r requirements.txt"
        CIBW_SKIP: "*-win32 *-musllinux*"
        CIBW_ARCHS_WINDOWS: "AMD64"
        CIBW_ENVIRONMENT_WINDOWS: "PYTHONPATH=$PYTHONPATH:$(python -c 'import site; print(\":\".join(site.getsitepackages() + [site.getusersitepackages()]))')"
        CIBW_COMMAND_TIMEOUT: "600"
        CIBW_TEST_COMMAND_TIMEOUT: "300"

    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: wheel_prebuild/*.whl

  create_release:
    name: Create Release with wheels
    runs-on: ubuntu-latest
    needs: build_wheels
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release_wheels

    - name: List all wheels
      run: find release_wheels -name "*.whl" | sort

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release_wheels/**/*.whl
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
